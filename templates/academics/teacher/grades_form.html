{% extends 'base.html' %}
{% load static %}

{% block title %}Registro de Calificaciones - {{ course.subject.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/labalsa_styles.css' %}">
<style>
    .grades-form {
        max-width: 800px;
        margin: 0 auto;
    }
    .student-row {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 0.5rem;
        background: #f8f9fa;
    }
    .student-row:hover {
        background: #e9ecef;
    }
    .grade-input {
        width: 80px;
        text-align: center;
        font-weight: bold;
        font-size: 1.1rem;
    }
    .grade-input:focus {
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        border-color: #28a745;
    }
    .school-header {
        background: linear-gradient(135deg, #0d6efd, #6610f2);
        color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
    }
    .grade-valid { border-color: #28a745; background-color: #d4edda; }
    .grade-invalid { border-color: #dc3545; background-color: #f8d7da; }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="school-header text-center">
        <div class="row align-items-center">
            <div class="col-md-2">
                <img src="{% static 'images/ESCUDO-IE-LA-BALSA.png' %}" alt="Escudo Institución Educativa La Balsa" 
                     class="school-shield">
            </div>
            <div class="col-md-8">
                <h3 class="mb-1">Institución Educativa La Balsa</h3>
                <h5 class="mb-0">Registro de Calificaciones</h5>
            </div>
            <div class="col-md-2">
                <a href="{% url 'academics:quick_grades' %}" class="btn btn-light btn-sm">
                    <i class="fas fa-arrow-left me-1"></i>Volver
                </a>
            </div>
        </div>
    </div>

    <div class="grades-form">
        <!-- Información de la actividad -->
        <div class="card mb-4">
            <div class="card-header bg-success" style="background: linear-gradient(135deg, #3CB371, #2E8B57) !important;">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-0" style="color: white !important; font-weight: 700 !important;">
                            <i class="fas fa-edit me-2" style="color: white !important;"></i>{{ activity_name }}
                        </h5>
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="badge bg-light text-dark">{{ activity_type|capfirst }}</span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Curso:</strong> {{ course.grade.name }} {{ course.section }}</p>
                        <p class="mb-1"><strong>Materia:</strong> {{ subject.name }}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Fecha:</strong> {{ date_recorded|date:"d/m/Y" }}</p>
                        <p class="mb-1"><strong>Período:</strong> {{ current_period.name }}</p>
                        <p class="mb-1"><strong>Estudiantes:</strong> {{ students.count }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulario de calificaciones -->
        <form id="gradesForm" method="post" action="{% url 'academics:save_grades' %}">
            {% csrf_token %}
            <input type="hidden" name="course_id" value="{{ course.id }}">
            <input type="hidden" name="subject_id" value="{{ subject.id }}">
            <input type="hidden" name="activity_name" value="{{ activity_name }}">
            <input type="hidden" name="activity_type" value="{{ activity_type }}">
            <input type="hidden" name="date_recorded" value="{{ date_recorded|date:'Y-m-d' }}">
            <input type="hidden" name="period_id" value="{{ current_period.id }}">
            
            <!-- Controles rápidos -->
            <div class="card mb-4">
                <div class="card-body">
                    <h6 class="mb-3">
                        <i class="fas fa-bolt me-2"></i>Acciones Rápidas
                    </h6>
                    <div class="row">
                        <div class="col-md-3">
                            <button type="button" class="btn btn-outline-success w-100" onclick="setAllGrades(5.0)">
                                <i class="fas fa-star me-1"></i>Todos 5.0
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-outline-primary w-100" onclick="setAllGrades(4.0)">
                                <i class="fas fa-thumbs-up me-1"></i>Todos 4.0
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-outline-warning w-100" onclick="setAllGrades(3.0)">
                                <i class="fas fa-minus me-1"></i>Todos 3.0
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-outline-secondary w-100" onclick="clearAllGrades()">
                                <i class="fas fa-eraser me-1"></i>Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de estudiantes -->
            <div class="card">
                <div class="card-header bg-info" style="background: linear-gradient(135deg, #228B22, #2E8B57) !important;">
                    <h6 class="mb-0" style="color: white !important; font-weight: 700 !important;">
                        <i class="fas fa-users me-2" style="color: white !important;"></i>Lista de Estudiantes ({{ students.count }})
                    </h6>
                </div>
                <div class="card-body">
                    {% for student in students %}
                        <div class="student-row">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center me-3" 
                                             style="width: 40px; height: 40px;">
                                            {{ student.user.first_name.0 }}{{ student.user.last_name.0 }}
                                        </div>
                                        <div>
                                            <h6 class="mb-0">{{ student.user.get_full_name }}</h6>
                                            <small class="text-muted">ID: {{ student.student_id }}</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">Calificación (1.0 - 5.0)</label>
                                </div>
                                <div class="col-md-3">
                                    <input type="number" 
                                           name="grade_{{ student.id }}" 
                                           id="grade_{{ student.id }}"
                                           class="form-control grade-input" 
                                           min="1.0" 
                                           max="5.0" 
                                           step="0.1" 
                                           placeholder="0.0"
                                           onchange="validateGrade(this)">
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-user-times fa-3x mb-3"></i>
                            <p>No hay estudiantes registrados en este curso</p>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Botones de acción -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <a href="{% url 'academics:quick_grades' %}" class="btn btn-secondary btn-lg w-100">
                        <i class="fas fa-arrow-left me-2"></i>Cancelar
                    </a>
                </div>
                <div class="col-md-6">
                    <button type="submit" class="btn btn-success btn-lg w-100" id="saveBtn" disabled>
                        <i class="fas fa-save me-2"></i>Guardar Calificaciones
                    </button>
                </div>
            </div>
        </form>

        <!-- Resumen estadístico -->
        <div class="card mt-4" id="summary" style="display: none;">
            <div class="card-body bg-light">
                <h6 class="text-muted mb-3">
                    <i class="fas fa-chart-bar me-2"></i>Resumen Estadístico
                </h6>
                <div class="row text-center">
                    <div class="col-3">
                        <h4 class="text-success mb-0" id="excellentCount">0</h4>
                        <small class="text-muted">Excelente (4.6-5.0)</small>
                    </div>
                    <div class="col-3">
                        <h4 class="text-primary mb-0" id="goodCount">0</h4>
                        <small class="text-muted">Bueno (3.6-4.5)</small>
                    </div>
                    <div class="col-3">
                        <h4 class="text-warning mb-0" id="basicCount">0</h4>
                        <small class="text-muted">Básico (3.0-3.5)</small>
                    </div>
                    <div class="col-3">
                        <h4 class="text-danger mb-0" id="lowCount">0</h4>
                        <small class="text-muted">Bajo (1.0-2.9)</small>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <strong>Promedio: <span id="averageGrade">0.0</span></strong>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let gradesData = {};
    
    function validateGrade(input) {
        const value = parseFloat(input.value);
        const studentId = input.id.replace('grade_', '');
        
        // Validar rango
        if (input.value === '') {
            input.classList.remove('grade-valid', 'grade-invalid');
            delete gradesData[studentId];
        } else if (value >= 1.0 && value <= 5.0) {
            input.classList.remove('grade-invalid');
            input.classList.add('grade-valid');
            gradesData[studentId] = value;
        } else {
            input.classList.remove('grade-valid');
            input.classList.add('grade-invalid');
            delete gradesData[studentId];
        }
        
        updateSummary();
        checkFormCompletion();
    }
    
    function setAllGrades(grade) {
        const gradeInputs = document.querySelectorAll('.grade-input');
        gradeInputs.forEach(input => {
            input.value = grade.toFixed(1);
            validateGrade(input);
        });
    }
    
    function clearAllGrades() {
        const gradeInputs = document.querySelectorAll('.grade-input');
        gradeInputs.forEach(input => {
            input.value = '';
            validateGrade(input);
        });
    }
    
    function updateSummary() {
        const grades = Object.values(gradesData);
        
        if (grades.length === 0) {
            document.getElementById('summary').style.display = 'none';
            return;
        }
        
        // Contar por categorías
        const excellent = grades.filter(g => g >= 4.6 && g <= 5.0).length;
        const good = grades.filter(g => g >= 3.6 && g < 4.6).length;
        const basic = grades.filter(g => g >= 3.0 && g < 3.6).length;
        const low = grades.filter(g => g >= 1.0 && g < 3.0).length;
        
        // Calcular promedio
        const average = grades.reduce((sum, g) => sum + g, 0) / grades.length;
        
        // Actualizar display
        document.getElementById('excellentCount').textContent = excellent;
        document.getElementById('goodCount').textContent = good;
        document.getElementById('basicCount').textContent = basic;
        document.getElementById('lowCount').textContent = low;
        document.getElementById('averageGrade').textContent = average.toFixed(2);
        
        document.getElementById('summary').style.display = 'block';
    }
    
    function checkFormCompletion() {
        const totalStudents = {{ students.count }};
        const gradedStudents = Object.keys(gradesData).length;
        const saveBtn = document.getElementById('saveBtn');
        
        if (gradedStudents > 0) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = `<i class="fas fa-save me-2"></i>Guardar Calificaciones (${gradedStudents}/${totalStudents})`;
        } else {
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Guardar Calificaciones';
        }
    }
    
    // Confirmar antes de enviar
    document.getElementById('gradesForm').addEventListener('submit', function(e) {
        const gradedStudents = Object.keys(gradesData).length;
        const totalStudents = {{ students.count }};
        
        if (gradedStudents === 0) {
            e.preventDefault();
            alert('Debe registrar al menos una calificación.');
            return;
        }
        
        if (gradedStudents < totalStudents) {
            const confirm = window.confirm(
                `Solo ha calificado ${gradedStudents} de ${totalStudents} estudiantes. \\n¿Está seguro de continuar?`
            );
            if (!confirm) {
                e.preventDefault();
            }
        }
    });
    
    // Validar en tiempo real mientras escribe
    document.querySelectorAll('.grade-input').forEach(input => {
        input.addEventListener('input', function() {
            validateGrade(this);
        });
    });
</script>
{% endblock %}